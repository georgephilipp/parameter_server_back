MLR_DIR := $(shell readlink $(dir $(lastword $(MAKEFILE_LIST))) -f)
MLR_TOOLS := $(MLR_DIR)/src/tools
PETUUM_ROOT = $(MLR_DIR)/../../

include $(PETUUM_ROOT)/defns.mk

MLR_SRC = $(wildcard $(MLR_DIR)/src/*.cpp)
MLR_HDR = $(wildcard $(MLR_DIR)/src/*.hpp)
MLR_BIN = $(MLR_DIR)/bin
MLR_OBJ = $(MLR_SRC:.cpp=.o)
NDEBUG = -DNDEBUG

all: mlr $(MLR_BIN)/gen_data_sparse
process_data: $(MLR_BIN)/process_data
mlr: $(MLR_DIR)/mlr_main


$(MLR_BIN):
	mkdir -p $(MLR_BIN)

$(MLR_DIR)/mlr_main: $(MLR_OBJ) $(PETUUM_PS_LIB) $(PETUUM_ML_LIB) $(MLR_BIN)
	$(PETUUM_CXX) $(PETUUM_CXXFLAGS) $(PETUUM_INCFLAGS) \
	$(MLR_OBJ) $(PETUUM_PS_LIB) $(PETUUM_ML_LIB) $(PETUUM_LDFLAGS) -L. -Wl,-rpath,$(MLR_DIR) -lgstd -o $@

$(MLR_OBJ): %.o: %.cpp $(MLR_HDR)
	$(PETUUM_CXX) $(NDEBUG) $(PETUUM_CXXFLAGS) -Wno-unused-result \
		$(PETUUM_INCFLAGS) -I. -c $< -o $@

$(MLR_TOOLS)/string_buffer.o: $(MLR_TOOLS)/string_buffer.cpp \
	$(MLR_TOOLS)/string_buffer.hpp
	$(PETUUM_CXX) $(NDEBUG) $(PETUUM_CXXFLAGS) -Wno-unused-result \
		$(PETUUM_INCFLAGS) -c $< -o $@


$(MLR_BIN)/gen_data_sparse: $(MLR_DIR)/src/tools/gen_data_sparse.cpp $(MLR_BIN) \
	$(MLR_TOOLS)/string_buffer.o
	$(PETUUM_CXX) $(PETUUM_CXXFLAGS) $(PETUUM_INCFLAGS) \
	$< $(PETUUM_PS_LIB) $(MLR_TOOLS)/string_buffer.o $(PETUUM_LDFLAGS) -o $@

$(MLR_BIN)/gen_data_sparse_fast: $(MLR_DIR)/src/tools/gen_data_sparse_fast.cpp $(MLR_BIN) \
	$(MLR_TOOLS)/string_buffer.o
	$(PETUUM_CXX) $(PETUUM_CXXFLAGS) $(PETUUM_INCFLAGS) \
	$< $(PETUUM_PS_LIB) $(MLR_TOOLS)/string_buffer.o $(PETUUM_LDFLAGS) -o $@

$(MLR_BIN)/process_data: $(MLR_DIR)/src/tools/process_data.cpp $(MLR_BIN)
	$(PETUUM_CXX) $(PETUUM_CXXFLAGS) $(PETUUM_INCFLAGS) \
	$< $(PETUUM_ML_LIB) $(PETUUM_PS_LIB) $(PETUUM_LDFLAGS) -o $@

clean:
	rm -rf $(MLR_OBJ)
	rm $(MLR_DIR)/mlr_main

.PHONY: clean, process_data
